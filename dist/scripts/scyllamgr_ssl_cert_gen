#!/usr/bin/env bash
#
# Copyright (C) 2017 ScyllaDB
#

set -eu -o pipefail

declare -r CRT_FILE="/var/lib/scylla-manager/scylla_manager.crt"
declare -r KEY_FILE="/var/lib/scylla-manager/scylla_manager.key"
declare -r SUBJECT="/C=US/ST=Scylla/L=Scylla/O=Scylla/OU=Scylla/CN=scylla.com"

print_usage() {
    echo "Usage: scyllamgr_ssl_cert_gen [--key <file>][--cert <file>][--subject <certificate subject>]"
    echo "  --cert      path to certificate to be generated, default ${CRT_FILE}"
    echo "  --key       path to key to the certificate, default ${KEY_FILE}"
    echo "  --subject   subject of the certificate, default ${SUBJECT}"
}

die() {
    echo -e "$@\n"
    print_usage
    exit 1
}

crt_file=${CRT_FILE}
key_file=${KEY_FILE}
subject=${SUBJECT}

while [[ $# > 0 ]]; do
    case "$1" in
        "--cert")
            crt_file=$2
            shift 2
            ;;
        "--key")
            key_file=$2
            shift 2
            ;;
        "--subject")
            subject=$2
            shift 2
            ;;
        "-h" | "--help")
            print_usage
            exit 0
            ;;
        -*)
            die "unknown option $1"
            ;;
    esac
done

openssl genrsa -out "${key_file}" 4096
openssl req -new -x509 -sha512 -subj "${subject}" -key "${key_file}" -out "${crt_file}" -days 365
chown scylla-manager:scylla-manager "${key_file}" "${crt_file}" ||:
